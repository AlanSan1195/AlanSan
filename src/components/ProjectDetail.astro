---
import Layout from "../layouts/Layout.astro";
import Github from "../assets/github.svg";
import WebSiteIcon from "../assets/website.svg";

interface Props {
  project: {
    id: string;
    section: string;
    title: string;
    subTitle: string;
    image: {
      src: string;
      srcHero?: string;
      alt: string;
    };
    links: {
      website?: string;
      github?: string;
    };
    review: string[];
    themes: string[];
    technologies: string[];
    technologiesDetails: Array<{
      name: string;
      description: string;
    }>;
    implementations: string[];
  };
}

const { project } = Astro.props;
const siteUrl = "https://alansan.dev";

// Limpiar HTML de los reviews para la descripción
const cleanDescription =
  project.review[0]?.replace(/<[^>]*>/g, "")?.substring(0, 160) + "..." ||
  project.subTitle;

// JSON-LD específico para el proyecto (SoftwareApplication/CreativeWork)
const projectJsonLd = {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "@id": `${siteUrl}/${project.id}`,
  name: project.title,
  description: project.subTitle,
  image: `${siteUrl}${project.image.srcHero ?? project.image.src}`,
  url: project.links.website,
  applicationCategory: "WebApplication",
  operatingSystem: "Web Browser",
  author: {
    "@type": "Person",
    "@id": `${siteUrl}/#person`,
    name: "Alan San",
  },
  creator: {
    "@type": "Person",
    "@id": `${siteUrl}/#person`,
    name: "Alan San",
  },
  ...(project.links.github && {
    codeRepository: project.links.github,
  }),
  programmingLanguage: project.technologies,
  keywords: [...project.themes, ...project.technologies].join(", "),
  offers: {
    "@type": "Offer",
    price: "0",
    priceCurrency: "USD",
    availability: "https://schema.org/OnlineOnly",
  },
};

// Breadcrumb JSON-LD
const breadcrumbJsonLd = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "Inicio",
      item: siteUrl,
    },
    {
      "@type": "ListItem",
      position: 2,
      name: "Proyectos",
      item: `${siteUrl}/proyectos`,
    },
    {
      "@type": "ListItem",
      position: 3,
      name: project.title,
      item: `${siteUrl}/${project.id}`,
    },
  ],
};

// Combinar ambos JSON-LD
const combinedJsonLd = {
  "@context": "https://schema.org",
  "@graph": [projectJsonLd, breadcrumbJsonLd],
};
---

<Layout
  title={`${project.title} - Proyecto de Alan San | Desarrollador Frontend`}
  description={cleanDescription}
  image={project.image.srcHero ?? project.image.src}
  type="article"
  jsonLd={combinedJsonLd}
>
  <article itemscope itemtype="https://schema.org/SoftwareApplication">
    <meta itemprop="applicationCategory" content="WebApplication" />
    <meta itemprop="operatingSystem" content="Web Browser" />

    <header
      class="relative max-w-3xl md:max-w-4xl mx-auto overflow-hidden pt-10"
    >
      <nav class="relative  mb-6" aria-label="Navegación del proyecto">
        <a
          href={`${project.section}`}
          class="p-2 w-fit bg-[var(--color-bg-secondary)] border-[1px] hover:bg-[var(--color-bg-card)] border-[var(--color-border)] outline outline-offset-[1px] outline-[var(--color-bg)] text-xl text-[var(--color-text-muted)] hover:text-[var(--color-text)] justify-center flex transition-colors"
          aria-label="Volver al portafolio principal"
        >
          <svg
            class="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
        </a>
      </nav>

      <div class="relative px-4 mb-6">
        <h1
          class="text-4xl md:text-5xl font-alpha text-[var(--color-text)] m-0"
          itemprop="name"
        >
          {project.title}
        </h1>

        <nav
          class="flex w-fit items-center gap-x-1"
          aria-label="Enlaces externos del proyecto"
        >
          {
            project.links.website && (
              <a
                href={project.links.website}
                target="_blank"
                rel="noopener noreferrer"
                class="text-[var(--color-text-secondary)] hover:text-[var(--color-text)] hover:scale-110 transition-all duration-100 focus:outline-none"
                aria-label={`Visitar sitio web de ${project.title}`}
                itemprop="url"
              >
                <WebSiteIcon
                  class="w-7 h-7 md:w-8 md:h-8 inline-block mr-2"
                  aria-hidden="true"
                />
              </a>
            )
          }
          {
            project.links.github && (
              <a
                href={project.links.github}
                target="_blank"
                rel="noopener noreferrer"
                aria-label={`Ver código fuente de ${project.title} en GitHub`}
                class="text-[var(--color-text-secondary)] hover:text-[var(--color-text)] hover:scale-110 transition-all duration-100 focus:outline-none"
                itemprop="codeRepository"
              >
                <Github class="w-7 h-7 md:w-8 md:h-8" aria-hidden="true" />
              </a>
            )
          }
        </nav>
        <div class="flex gap-x-2">
          {
            project.themes.length > 0 && (
              <div
                class="flex flex-wrap w-full gap-2 mt-6"
                role="list"
                aria-label="Temas del proyecto"
              >
                {project.themes.map((theme) => (
                  <span
                    class="px-3 py-1 bg-[var(--color-bg-secondary)] border-[1px] hover:bg-[var(--color-bg-card)] border-[var(--color-border-hover)] outline outline-offset-[1px] outline-[var(--color-bg)] text-xs md:text-md text-[var(--color-text-muted)] font-king"
                    role="listitem"
                    itemprop="keywords"
                  >
                    #{theme}
                  </span>
                ))}
              </div>
            )
          }
        </div>
      </div>

      <figure class="max-w-4xl mx-auto px-4">
        <img
          transition:name={`transition-${project.id}`}
          src={project.image.srcHero ?? project.image.src}
          alt={project.image.alt}
          class="w-full h-auto object-cover bg-[var(--color-bg-card)] border-[1.5px] border-[var(--color-border)] outline outline-offset-[1px] outline-[var(--color-bg)]"
          loading="eager"
          itemprop="image"
          width="1200"
          height="675"
        />
        <figcaption class="sr-only">{project.image.alt}</figcaption>
      </figure>
    </header>

    {
      project.review.length > 0 && (
        <section
          class="max-w-3xl md:max-w-4xl mx-auto"
          aria-labelledby="project-overview"
        >
          <div class="px-4">
            <h2
              id="project-overview"
              class="text-2xl md:text-5xl font-alpha text-[var(--color-text)]"
            >
              {project.subTitle}
            </h2>
            <div class="flex flex-col" itemprop="description">
              {project.review.map((paragraph) => (
                <p
                  class="font-satoshi text-base md:text-xl text-pretty text-[var(--color-text-secondary)] mb-4"
                  set:html={paragraph}
                />
              ))}
            </div>
          </div>
        </section>
      )
    }

    {
      project.technologiesDetails.length > 0 && (
        <section
          class="py-6 z-10 max-w-3xl md:max-w-4xl mx-auto px-4"
          aria-labelledby="technologies-section"
        >
          <div class="px-4">
            <h2
              id="technologies-section"
              class="text-2xl md:text-5xl font-alpha text-[var(--color-text)] mb-6"
            >
              Tecnologías Utilizadas
            </h2>
            <ol class="space-y-3 md:space-y-8 list-decimal px-1">
              {project.technologiesDetails.map((tech) => (
                <li>
                  <p class="font-satoshi text-sm md:text-xl text-pretty text-[var(--color-text-secondary)]">
                    <strong class="text-[var(--color-text)]" itemprop="programmingLanguage">
                      {tech.name}:
                    </strong>{" "}
                    <span>{tech.description}</span>
                  </p>
                </li>
              ))}
            </ol>
          </div>
        </section>
      )
    }

    {
      project.implementations.length > 0 && (
        <section
          class="py-6 z-10 max-w-3xl md:max-w-4xl mx-auto"
          aria-labelledby="implementations-section"
        >
          <div class="px-4">
            <h2
              id="implementations-section"
              class="text-2xl md:text-5xl font-alpha text-[var(--color-text)] mb-6"
            >
              Implementaciones
            </h2>

            <ul
              class="space-yxl text-[var(--color-text-secondary)] font-satoshi px-1"
              itemprop="featureList"
            >
              {project.implementations.map((implementation) => (
                <li class="flex font-satoshi m-0 text-[var(--color-text-secondary)] text-sm md:text-xl">
                  <span
                    class="text-[var(--color-accent)] mr-2"
                    aria-hidden="true"
                  >
                    •
                  </span>
                  <span>{implementation}</span>
                </li>
              ))}
            </ul>
          </div>
        </section>
      )
    }

    <footer class="px-5 pb-8 w-fit">
      <p class="text-lg m-0 font-alpha">
        Enlace al proyecto:
        <a
          href={project.links.website}
          class="text-[var(--color-accent)] no-underline hover:underline m-0"
          target="_blank"
          rel="noopener noreferrer"
          itemprop="url"
        >
          {project.links.website}
        </a>
      </p>

      <!-- Author info for SEO -->
      <div
        class="mt-4 text-sm text-[var(--color-text-muted)]"
        itemprop="author"
        itemscope
        itemtype="https://schema.org/Person"
      >
      </div>
    </footer>
  </article>
</Layout>

<style>
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
</style>
